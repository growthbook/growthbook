# GrowthBook Cursor Rules

You are working on GrowthBook, an open-source feature flagging and A/B testing platform. Follow these rules and conventions when assisting with code.

## Project Architecture

### Monorepo Structure

- This is a monorepo managed by **pnpm workspaces**
- Use `pnpm` for all package management operations (never npm or yarn)
- Packages are located in the `packages/` directory

### Package Organization

**packages/front-end** - Next.js application (UI)

- Next.js app serving the full GrowthBook UI
- Runs on http://localhost:3000 in development
- TypeScript with React functional components
- Uses path alias `@/` for imports (e.g., `@/components`, `@/services`, `@/ui`)

**packages/back-end** - Express API server

- Runs on http://localhost:3100 in development
- MongoDB as primary data store
- Uses `back-end/` prefix for internal imports
- Serves two distinct APIs:
  1. **Internal API** - Used by the GrowthBook front-end application (controllers, routers in `src/controllers/`, `src/routers/`)
  2. **External REST API** - Public API for customers to integrate with GrowthBook (located in `src/api/` directory)

**packages/shared** - Shared TypeScript code

- Common types, utilities, validators, and constants
- Shared between front-end and back-end
- No UI components or server-specific code

**packages/stats** - Python statistics engine

- Python 3.9+ package called `gbstats`
- Managed by Poetry for dependencies
- Statistical computations for A/B testing
- Uses pandas, numpy, scipy

**packages/sdk-js** - JavaScript SDK

- Published as `@growthbook/growthbook` on npm
- Fully isolated from internal packages

**packages/sdk-react** - React SDK

- Published as `@growthbook/growthbook-react` on npm
- Fully isolated from internal packages

### Enterprise Code

- `packages/front-end/enterprise/` - Non-open source front-end features
- `packages/back-end/src/enterprise/` - Non-open source back-end features
- `packages/shared/src/enterprise/` - Non-open source shared code
- Do NOT typically accept outside contributions to enterprise directories

## Critical Package Import Restrictions

These are enforced by ESLint and must be strictly followed:

### Front-end Package

- ✅ CAN import from: `shared` package, itself
- ❌ CANNOT import from: `back-end`, `sdk-js`, `sdk-react`
- ❌ DO NOT import Radix UI components directly - use design system wrappers from `@/ui/` instead
  - Bad: `import { Button } from "@radix-ui/themes"`
  - Good: `import { Button } from "@/ui/Button"`
  - Affected components: Avatar, Badge, Button, Callout, Checkbox, DataList, DropdownMenu, Link, RadioCards, RadioGroup, Select, Switch, Table, Tabs
- ❌ DO NOT use `window.history.pushState` or `window.history.replaceState` directly
  - Use `router.push(url, undefined, { shallow: true })` from `next/router` instead

### Back-end Package

- ✅ CAN import from: `shared` package, itself
- ❌ CANNOT import from: `front-end`, `sdk-js`, `sdk-react`
- ❌ DO NOT import `node-fetch` directly
  - Use `import { fetch } from "back-end/src/util/http.util"` instead

### Shared Package

- ✅ CAN import from: itself only
- ❌ CANNOT import from: `back-end`, `front-end`
- ❌ DO NOT use `.default()` on Zod schemas in `packages/shared/src/validators/*`
  - Use the `defaultValues` option in the BaseModel config instead

### SDK Packages

- ✅ CAN import from: themselves only
- ❌ CANNOT import from: `back-end`, `front-end`, `shared`, or any internal package
- Must remain fully isolated for npm distribution

## TypeScript & React Conventions

### Component Structure

- Use **functional components** with TypeScript
- Define props interfaces inline or as separate types
- Use explicit return types for complex functions

Example structure:

```typescript
import { ReactNode } from "react";
import { useUser } from "@/services/UserContext";

export default function MyComponent({
  value,
  onChange,
  disabled = false,
}: {
  value: string;
  onChange: (value: string) => void;
  disabled?: boolean;
}) {
  const { organization, hasCommercialFeature } = useUser();
  const hasFeature = hasCommercialFeature("feature-name");

  // Component logic here

  return (
    <div>
      {/* JSX here */}
    </div>
  );
}
```

### Commercial Features

- Check feature availability with `hasCommercialFeature("feature-name")`
- Wrap premium features with `<PremiumTooltip commercialFeature="feature-name">`
- Feature flags are defined in `packages/shared/src/enterprise/license-consts.ts`

## Backend API Patterns

### Router Organization

- API routes are in `packages/back-end/src/api/`
- Each resource has its own directory with a `*.router.ts` file
- Example structure:
  ```
  api/
    features/
      features.router.ts
      getFeature.ts
      postFeature.ts
      ...
  ```

### Controller Pattern

- Controllers are in `packages/back-end/src/controllers/`
- Wrap controllers with `wrapController()` for automatic error handling
- Controllers export named functions that are HTTP handlers

### Request Validation

- Use Zod for request validation
- Validators are in `packages/back-end/src/validators/`
- Validators in `packages/shared/src/validators/` are shared with front-end

### Authentication & Authorization

- Middleware: `authenticateApiRequestMiddleware`
- Context includes: `req.context.org`, `req.context.models`, `req.context.permissions`
- Check permissions before sensitive operations

## Development Guidelines

### General Rules

- **Do NOT write tests** unless explicitly requested by the user
- Follow existing patterns in the codebase
- When in doubt, search for similar existing code and follow that pattern
- Use existing ESLint rules - they're comprehensive and enforced in CI
- Do not use //eslint-disable-next-line comments to fix type issues.

### Code Quality

- TypeScript: Use strict types, avoid `any` when possible (ESLint warns on `any`)
- Unused variables: Prefix with `_` to indicate intentionally unused
- Console logging: Avoid `console.log` in production code (ESLint warns)

### Common Patterns

**Zod Validation**

```typescript
import { z } from "zod";

const mySchema = z.object({
  name: z.string(),
  count: z.number().int().positive(),
});

type MyType = z.infer<typeof mySchema>;
```

**Type Definitions**

- Shared types go in `packages/shared/types/*.d.ts`
- Use `.d.ts` files for type-only definitions
- Export types with `export type` or `export interface`

**Environment Variables**

- Back-end: Define in `packages/back-end/src/util/secrets.ts`
- Front-end: Define in `packages/front-end/services/env.ts`
- Use environment-specific `.env.local` files for local overrides

### Code Quality

- **Lint**: `pnpm lint` (auto-fixes issues)
- **Type check**: `pnpm type-check` (all packages)
- **Format**: `pnpm pretty` (Prettier formatting)

## Summary

When assisting with GrowthBook development:

1. **Respect package boundaries** - front-end, back-end, and shared have strict import restrictions
2. **Use design system components** - don't import Radix UI directly in front-end
3. **Follow existing patterns** - search the codebase for similar code
4. **Use pnpm** - this is a pnpm workspace
5. **No tests by default** - only write tests if explicitly requested
6. **TypeScript strict mode** - use proper types, avoid `any`
7. **Check commercial features** - use `hasCommercialFeature()` for premium functionality
8. **Router pattern for APIs** - organize by resource with dedicated router files
9. **Leverage the BaseModel** - when adding a new model, we should default to using the BaseModel except for rare cases

These rules ensure consistency and maintainability across the GrowthBook codebase.
