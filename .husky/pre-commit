#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

has_changes() {
  git status --porcelain | grep '^[MADRC]' | grep -E "$1" || true
}

openapi=$(has_changes "back-end/src/api/openapi")
if [ -n "$openapi" ]
  then
    echo "#### OpenAPI spec changed"
fi

modelschanged=$(has_changes "back-end/src/models")
if [ -n "$modelschanged" ]
  then
    echo "#### Backend models changed"
fi

if [ -n "$openapi" ] || [ -n "$modelschanged" ]
  then
    echo "#### Running generate-api-types and adding changes"
    pnpm generate-api-types
    git add packages/shared/types/openapi.d.ts
    git add packages/back-end/generated/spec.yaml
    git add packages/shared/src/validators/openapi.ts
fi

eslintconfigchanged=$(has_changes "eslint.config.mjs")
if [ -n "$eslintconfigchanged" ]
  then
    echo "#### ESLint config changed, regenerating suppressions"
    pnpm eslint --suppress-all --pass-on-unpruned-suppressions .
fi

echo "#### Linting typescript, scss, and markdown files"
pnpm lint-staged

# Add eslint-suppressions.json if it was modified during linting
if [ -n "$(git status --porcelain eslint-suppressions.json)" ]
  then
    echo "#### Adding updated eslint-suppressions.json"
    git add eslint-suppressions.json
fi

docchanged=$(has_changes "back-end/src/events|shared/scripts/gen-event-webhook-doc.ts")
if [ -n "$docchanged" ]
  then
    echo "#### Generating doc files"
    pnpm --filter shared gen-event-webhook-for-docs
    git add docs
fi

sdkchanged=$(has_changes "shared/src/sdk-versioning|shared/scripts/gen-sdk-resources.ts")
if [ -n "$sdkchanged" ]; then
  echo "#### sdk-versioning or gen-sdk-resources.ts changed, running gen-sdk-resources"
  pnpm --filter shared gen-sdk-resources-for-docs
  git add docs
fi

commercialchanged=$(has_changes "shared/src/enterprise/license-consts|shared/scripts/gen-commercial-features-for-docs.ts")
if [ -n "$commercialchanged" ]; then
  echo "#### license-consts or gen-commercial-features-for-docs.ts changed, running gen-commercial-features-for-docs"
  pnpm --filter shared gen-commercial-features-for-docs
  git add docs
fi
