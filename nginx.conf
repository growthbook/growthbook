events {
    worker_connections 1024;
}

http {
    upstream growthbook_frontend {
        server growthbook:3000;
    }
    
    upstream growthbook_api {
        server growthbook:3100;
    }

    server {
        listen 80;
        
        # Frontend static assets (definitely frontend)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
            proxy_pass http://growthbook_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # Frontend Next.js specific routes (definitely frontend)
        location ~ ^/(_next|logo|favicon\.ico) {
            proxy_pass http://growthbook_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # /api/init should go to frontend (Next.js API route)
        location = /api/init {
            proxy_pass http://growthbook_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # Other /api/ routes go to backend API
        location /api/ {
            proxy_pass http://growthbook_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # AJAX requests to experiments endpoint
        location = /experiments {
            proxy_pass http://growthbook_api/experiments;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # Known frontend page routes ONLY (everything else goes to API)
        location ~ ^/(features|metrics|settings|account|dashboard|projects|teams|dimensions|segments|ideas|presentations|getstarted|importing|webhooks|events|billing|admin|learning|timeline|sdks|fact-metrics|invitation|bandits|templates|power-calculator|namespaces|fact-tables|datasources|sql-explorer|learnings|metric-effects|correlations|attributes|environments|saved-groups|archetypes|tags|customfields|keys)($|/) {
            proxy_pass http://growthbook_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # Home page
        location = / {
            proxy_pass http://growthbook_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # WebSocket support for API
        location /api/realtime {
            proxy_pass http://growthbook_api/realtime;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Port 80;
        }
        
        # DEFAULT: Everything else goes to API (this catches ALL unknown routes)
        location / {
            proxy_pass http://growthbook_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 80;
        }
    }
}