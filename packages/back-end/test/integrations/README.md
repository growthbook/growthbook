# Testing GrowthBooks SQL Integration for Experiments

This folder contains scripts used to automatically lint and run SQL generated by the `getExperimentMetricQuery()` method that all of our SQL integrations use to generate metric values for the Python stats library `gbstats`. Testing these queries is difficult because there are (a) many SQL languages that have their own rules and often require their own DBs and (b) they are somewhat modular in how they are built, but unit testing each step is almost more complicated to set up.

Therefore, this folder contains scripts to generate experiment metric queries for a wide range of engines and experiment-metric configurations and then execute them against a variety of DBs. The output can then be compared using a Jupyter notebook, akin to the one here.

## How to use it

`yarn workspace back-end test-integration-queries`

This for now just runs `integration-query-test.sh` which itself:

1. Loads environment via `source ~/.env`
2. Generates the queries using `integration-query-generator.ts`
3. Lints and executes the queries, storing results and using a cache, using `integration-query-runner.py`

You will need:

1. To set up local/cloud (for now) MySQL, Postgres, Presto DBs and have BigQuery and Snowflake instances with data loaded from the back-end data generator (see the back-end README for instructions on how to create and load this data).
2. A `.env` file that looks like the following, replacing XXX with the appropriate values for the databases you set up in step 1:

```
export MYSQL_TEST_HOST=XXX
export MYSQL_TEST_USER=XXX
export MYSQL_TEST_DATABASE=XXX
export MYSQL_TEST_PASSWORD=XXX

export POSTGRES_TEST_HOST=XXX
export POSTGRES_TEST_USER=XXX
export POSTGRES_TEST_DATABASE=XXX

export SNOWFLAKE_TEST_ACCOUNT=XXX
export SNOWFLAKE_TEST_DATABASE=XXX
export SNOWFLAKE_TEST_SCHEMA=XXX
export SNOWFLAKE_TEST_USER=XXX
export SNOWFLAKE_TEST_PASSWORD=XXX

export PRESTO_TEST_HOST=XXX
export PRESTO_TEST_PORT=XXX
export PRESTO_TEST_USER=XXX
export PRESTO_TEST_CATALOG=XXX
export PRESTO_TEST_SCHEMA=XXX

export GOOGLE_APPLICATION_CREDENTIALS="XXX.json"
```

3. The requisite python connectors in `integration-query-runner.py` installed on your machine.
