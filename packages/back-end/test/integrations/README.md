# Testing GrowthBooks SQL Integration for Experiments

This folder contains scripts used to automatically lint and run SQL generated by the `getExperimentMetricQuery()` method that all of our SQL integrations use to generate metric values for the Python stats library `gbstats`. Testing these queries is difficult because there are (a) many SQL languages that have their own rules and often require their own DBs and (b) while the queries are somewhat modular in how they are built, they only can be effectively tested once stitched together.

Therefore, this folder contains scripts to generate experiment metric queries for a wide range of engines and experiment-metric configurations and then execute them against a variety of DBs. The output can then be compared using a Jupyter notebook, akin to the one here.

## Pre-requisites

1. Databases to connect to or set up. The section below will tell you whether you need to set it up locally or will need to ask for the credentials to a cloud instance.
2. A `.env` file with credentials for the DB connections. `.env.example` in this folder has the field names that you will need to specify.
3. The requisite python connectors in `integration-query-runner.py` installed on your machine. These are specified in this folder's pyproject.toml file. You can install these by changing to this directory and running `poetry install`.

### DBs that you can connect to

The testing infrastructure currently works for the following database engines, with whether or not GrowthBook manages a cloud instance

- MySQL (local)
- Postgres (local)
- MS SQL, or SQL Server (local)
- Presto (local)
- BigQuery (cloud)
- ClickHouse (cloud)
- Databricks (cloud)
- Redshift (cloud)
- Snowflake (cloud)

### Setting up databases

The example queries and metrics are configured to work with data that comes out of the sample data generator, which you can find in `packages/back-end/test/data-generator`.

## How to use it

If you satisfy the (hefty) pre-requisites above, you can simply run the following once in the main git branch and whatever branch you wish to test:
`yarn workspace back-end test-integration-queries`

This script accepts positional arguments. Note, due to restrictions with yarn, if you want to enter the 2nd, 3rd, etc. arguments, you must enter a value for the preceding arguments.

1st argument: Add `nocache` if you want to ignore the cache, and use anything else, e.g. `cache` if you want to use the cache (default)
2nd argument: Which engines to run queries for, in a comma separated list (e.g. `bigquery,presto`). You can see their names at the bottom of `integration-query-runner.py` (default is all of them)
3rd argument: A filter that must match the test `name` for the test to run (e.g. `activation` will run any test where `activation` is in the test `name`)

For example `yarn workspace back-end test-integration-queries nocache bigquery` will run all bigquery tests, ignoring any cached values.

Once that script runs, you can use a [notebook like this one](https://colab.research.google.com/drive/1J-VBFGQ2a_7cyarrNRPXuHlQXVfB55yy?usp=sharing) to compare two sets of results across the main and dev branch from which you ran the above script.

The `test-integration-queries` command runs `integration-query-test.sh` which itself:

1. Generates the queries using `integration-query-generator.ts`
2. Gets the current git branch
3. Lints and executes the queries, storing results using the current git branch as part of the file name, using `integration-query-runner.py`

## Caching

Note a shared cache in your `/tmp/` folder is used for each run. If the combination of SQL engine and SQL query itself is identical, the results should be pulled directly from the cache rather than re-generated.

## Other notes

If contributing to this python script, please consider linting with `black` and `flake8`.

GrowthBook team members can read more documentation and which integrations/configurations are covered in this doc: https://www.notion.so/growthbook/Testing-Stats-Integrations-4e549c1591de444ea0f19473d3257f7d#24e7d771aece432f9aeeaad9e8aabfa7
